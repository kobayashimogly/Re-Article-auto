// src/phaseD/generateBody.js
import { validateBody } from "./validateBody.js";
import { callGemini } from "../utils/callGemini.js";

const MAX_LOOP = 6;

export async function generateBodyWithLoop(keyword, target) {
  let body = "";
  let check = null;

  // 1) åˆå›ç”Ÿæˆ
  console.log(`âœï¸ æœ¬æ–‡ç”Ÿæˆ 1/${MAX_LOOP} â†’ ${target.title}`);
  const firstPrompt = buildBodyPrompt(keyword, target);
  body = extractBody(await callGemini(firstPrompt));

  check = validateBody(body, target.level);
  if (check.ok) {
    console.log("âœ… æœ¬æ–‡ç”ŸæˆæˆåŠŸï¼ˆåˆå›ï¼‰");
    return body;
  }

  console.log("âš ï¸ æœ¬æ–‡ã‚¨ãƒ©ãƒ¼ï¼ˆåˆå›ï¼‰:", check.errors);

  // 2) ä¿®æ­£ãƒ«ãƒ¼ãƒ—ï¼ˆ2å›ç›®ä»¥é™ï¼‰
  for (let i = 2; i <= MAX_LOOP; i++) {
    console.log(`ğŸ› ï¸ æœ¬æ–‡ä¿®æ­£ ${i}/${MAX_LOOP} â†’ ${target.title}`);

    const fixPrompt = buildFixPrompt(keyword, target, body, check.errors);
    body = extractBody(await callGemini(fixPrompt));

    check = validateBody(body, target.level);
    if (check.ok) {
      console.log("âœ… æœ¬æ–‡ä¿®æ­£æˆåŠŸ");
      return body;
    }

    console.log("âš ï¸ æœ¬æ–‡ã‚¨ãƒ©ãƒ¼:", check.errors);
  }

  // â˜…â˜…â˜… ã“ã“ãŒé‡è¦ï¼šå¤±æ•—ã—ã¦ã‚‚æ­¢ã‚ãªã„ â˜…â˜…â˜…
  console.warn(
    `âš ï¸ æœ¬æ–‡ãŒ ${MAX_LOOP} å›ä»¥å†…ã«åˆæ ¼ã—ã¾ã›ã‚“ã§ã—ãŸãŒã€ãã®ã¾ã¾é€šéã—ã¾ã™ â†’ ${target.title}`
  );
  console.warn("æœ€çµ‚ã‚¨ãƒ©ãƒ¼:", check?.errors);

  // throw ã—ãªã„ã§ã€Œæœ€å¾Œã®æœ¬æ–‡ã€ã‚’è¿”ã™
  return body;
}


// ----------------------
// åˆå›ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
// ----------------------
function buildBodyPrompt(keyword, target) {
  return `
ã‚ãªãŸã¯æ—¥æœ¬æœ€å¤§è¦æ¨¡ã®å°±æ´»ãƒ¡ãƒ‡ã‚£ã‚¢ã®ç·¨é›†é•·ã§ã™ã€‚

# å¯¾è±¡è¦‹å‡ºã—
${target.title}

# éšå±¤
${target.level}

# çµ¶å¯¾ãƒ«ãƒ¼ãƒ«
- ä¸å¯§èª
- å°±æ´»ãƒ»ESå‘ã‘æ–‡ä½“
- æœ¬æ–‡ã®ã¿å‡ºåŠ›
- ä¸å¯§èªã§çµ‚ã‚ã‚‹
- æ–‡æœ«ã¯å¿…ãšã€Œã€œã§ã™ã€ã€Œã€œã¾ã™ã€ã§çµ‚ãˆã‚‹ã“ã¨
- æœ¬æ–‡ä¸­ã§é‡è¦ãªå˜èªã«ã‚„ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’[[YELLOW]] ã¨[[/YELLOW]]ã§å›²ã£ã¦ã»ã—ã„ã€‚ã“ã‚Œã‚’æœ€ä½1ã¤å…¥ã‚Œã‚‹ï¼ˆæœ¬æ–‡å†…ã«å…¥ã‚Œã‚‹ã€‚è¦‹å‡ºã—ã«å…¥ã‚Œãªã„ï¼‰
- ç¦æ­¢è¨˜å·ï¼ˆâ€ â€œ ã€Œ ã€ * "ï¼‰ã¯ç¦æ­¢
- ã€Œã€ãªã©ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§
- æ–‡å­—æ•°ã¯éšå±¤ã«å¿œã˜ã¦å³å®ˆ
- æ–‡å­—æ•°ã¯200ã€œ250å­—ï¼ˆå³å®ˆï¼‰
- å†…å®¹ã¯ã€Œè¦‹å‡ºã—ã«å¯¾ã™ã‚‹æœ¬æ–‡ã€ã«ãªã£ã¦ã„ã‚‹ã“ã¨ï¼ˆã‚ºãƒ¬ç¦æ­¢ï¼‰

ã§ã¯æœ¬æ–‡ã®ã¿ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚
`.trim();
}

// ----------------------
// ä¿®æ­£ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆã“ã“ãŒè‚ï¼‰
// ----------------------
function buildFixPrompt(keyword, target, originalBody, errors) {
  return `
ã‚ãªãŸã¯æ—¥æœ¬æœ€å¤§è¦æ¨¡ã®å°±æ´»ãƒ¡ãƒ‡ã‚£ã‚¢ã®ç·¨é›†é•·ã§ã™ã€‚
ä»¥ä¸‹ã®æœ¬æ–‡ã«ã¯ãƒ«ãƒ¼ãƒ«é•åãŒã‚ã‚Šã¾ã™ã€‚ã‚¨ãƒ©ãƒ¼ã‚’ã™ã¹ã¦è§£æ¶ˆã—ãŸã€Œä¿®æ­£ç‰ˆæœ¬æ–‡ã€ã ã‘ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

# å¯¾è±¡ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
${keyword}

# å¯¾è±¡è¦‹å‡ºã—
${target.title}

# éšå±¤
${target.level}

# çµ¶å¯¾ãƒ«ãƒ¼ãƒ«
- ä¸å¯§èª
- å°±æ´»ãƒ»ESå‘ã‘æ–‡ä½“
- æœ¬æ–‡ã®ã¿å‡ºåŠ›
- ä¸å¯§èªã§çµ‚ã‚ã‚‹
- æ–‡æœ«ã¯å¿…ãšã€Œã€œã§ã™ã€ã€Œã€œã¾ã™ã€ã§çµ‚ãˆã‚‹ã“ã¨
- æœ¬æ–‡ä¸­ã§é‡è¦ãªå˜èªã«ã‚„ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’[[YELLOW]] ã¨[[/YELLOW]]ã§å›²ã£ã¦ã»ã—ã„ã€‚ã“ã‚Œã‚’æœ€ä½1ã¤å…¥ã‚Œã‚‹ï¼ˆæœ¬æ–‡å†…ã«å…¥ã‚Œã‚‹ã€‚è¦‹å‡ºã—ã«å…¥ã‚Œãªã„ï¼‰
- ç¦æ­¢è¨˜å·ï¼ˆâ€ â€œ ã€Œ ã€ * "ï¼‰ã¯ç¦æ­¢
- ã€Œã€ãªã©ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§
- æ–‡å­—æ•°ã¯éšå±¤ã«å¿œã˜ã¦å³å®ˆ
- æ–‡å­—æ•°ã¯200ã€œ250å­—ï¼ˆå³å®ˆï¼‰
- å†…å®¹ã¯ã€Œè¦‹å‡ºã—ã«å¯¾ã™ã‚‹æœ¬æ–‡ã€ã«ãªã£ã¦ã„ã‚‹ã“ã¨ï¼ˆã‚ºãƒ¬ç¦æ­¢ï¼‰

# ã‚¨ãƒ©ãƒ¼ä¸€è¦§ï¼ˆå¿…ãšã™ã¹ã¦ç›´ã™ï¼‰
${errors.map(e => `- ${e}`).join("\n")}

# å…ƒæœ¬æ–‡
${originalBody}

ä¸Šè¨˜ã‚¨ãƒ©ãƒ¼ã‚’è§£æ¶ˆã—ãŸã€Œä¿®æ­£ç‰ˆæœ¬æ–‡ã€ã ã‘ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
`.trim();
}

function extractBody(text) {
  return String(text || "")
    .replace(/```[\s\S]*?```/g, (m) => m.replace(/```/g, "")) // å¿µã®ãŸã‚
    .replace(/```/g, "")
    .trim();
}
